<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maskaari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // ===================================================================================
        // FIREBASE INITIALIZATION üîê
        // ===================================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyAxg4Pisi8D3CttLUk67fUxkCoDBj31hQs",
          authDomain: "maskaari-6fb1a.firebaseapp.com",
          projectId: "maskaari-6fb1a",
          storageBucket: "maskaari-6fb1a.firebasestorage.app",
          messagingSenderId: "388880104222",
          appId: "1:388880104222:web:54002549227019975de70f",
          measurementId: "G-9Q9TRSBR6V"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        // ADDED: Initialize Firestore
        const db = firebase.firestore();

        // ===================================================================================
        // APP STATE & MOCK DATA
        // ===================================================================================
        let state = {
            // MODIFIED: Start on the login screen
            view: 'login', 
            user: null,   // Will hold user data like { phoneNumber, name, address }
            menu: [
                { id: 1, name: "Gourmet Burger", description: "Angus beef, cheddar, lettuce, tomato, special sauce.", price: 12.99, image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=400&q=80" },
                { id: 2, name: "Margherita Pizza", description: "Fresh mozzarella, San Marzano tomatoes, basil.", price: 14.50, image: "https://images.unsplash.com/photo-1598021680133-eb3a7331d324?auto=format&fit=crop&w=400&q=80" },
                { id: 3, name: "Chicken Caesar Salad", description: "Grilled chicken, romaine, croutons, and Parmesan.", price: 10.25, image: "https://images.unsplash.com/photo-1550304943-4f24f54ddde9?auto=format&fit=crop&w=400&q=80" },
            ],
            cart: [],
            loginState: {
                isOtpSent: false,
                confirmationResult: null,
                phoneNumber: ''
            }
        };

        // ===================================================================================
        // RENDER FUNCTIONS
        // ===================================================================================
        
        function render() {
            const app = document.getElementById('app');
            // MODIFIED: Logic to enforce login-first flow
            let currentViewHTML = renderCurrentView();
            if (!state.user && state.view !== 'login') {
                state.view = 'login';
                currentViewHTML = renderLogin();
            }

            const html = `<div class="max-w-md mx-auto bg-gray-100 min-h-screen flex flex-col">${renderHeader()}<main class="flex-1 pb-24">${currentViewHTML}</main>${state.user ? renderFooter() : ''}</div>`;
            app.innerHTML = html;

            if (state.view === 'login' && !state.loginState.isOtpSent) {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible', 'callback': (response) => {}
                });
            }
        }

        function renderHeader() {
            // MODIFIED: Add a profile icon when logged in
            return `
                <header class="p-4 sticky top-0 bg-white/80 backdrop-blur-sm z-10 shadow-sm flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Maskaari</h1>
                    ${state.user ? `
                        <button data-action="setView" data-view="profile" class="p-2 rounded-full hover:bg-gray-200">
                           <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </button>
                    ` : ''}
                </header>
            `;
        }
        
        function renderFooter() {
            // ... (renderFooter is unchanged) ...
            const totalCartItems = state.cart.reduce((sum, item) => sum + item.quantity, 0); return `<footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200"><nav class="flex justify-around h-16"><button data-action="setView" data-view="menu" class="flex flex-col items-center justify-center w-1/2 ${state.view === 'menu' ? 'text-green-600' : 'text-gray-500'}"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg><span class="text-xs font-medium">Menu</span></button><button data-action="setView" data-view="cart" class="relative flex flex-col items-center justify-center w-1/2 ${state.view === 'cart' ? 'text-green-600' : 'text-gray-500'}"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-5.514a1.875 1.875 0 0 0-1.642-2.58H5.169m-1.883 5.514A2.25 2.25 0 0 1 6.331 8.25h11.338a2.25 2.25 0 0 1 2.15 3.28l-1.838 5.514a2.25 2.25 0 0 1-2.15 1.626H6.331a2.25 2.25 0 0 1-2.15-3.28l.044-.135Z"></path></svg>${totalCartItems > 0 ? `<span class="absolute top-1 right-1/2 -mr-8 w-5 h-5 bg-green-600 text-white text-xs font-bold rounded-full flex items-center justify-center">${totalCartItems}</span>` : ''}<span class="text-xs font-medium">Cart</span></button></nav></footer>`;
        }
        
        function renderCurrentView() {
            switch (state.view) {
                case 'menu': return renderMenu();
                case 'cart': return renderCart();
                case 'login': return renderLogin();
                // ADDED: New views for profile creation and viewing
                case 'createProfile': return renderCreateProfile();
                case 'profile': return renderProfilePage();
                default: return renderLogin(); // Default to login if view is unknown
            }
        }
        
        // ADDED: Function to render the profile creation form
        function renderCreateProfile() {
            return `<div class="p-6">
                        <h2 class="text-2xl font-bold mb-4">Complete Your Profile</h2>
                        <p class="text-gray-600 mb-6">Welcome! Please enter your details to continue.</p>
                        <form data-action="saveProfile">
                            <div class="mb-4">
                                <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input id="name" type="text" placeholder="Your full name" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required />
                            </div>
                            <div class="mb-6">
                                <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                                <textarea id="address" placeholder="Your delivery address" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Save and Continue</button>
                        </form>
                    </div>`;
        }
        
        // ADDED: Function to render the user's profile page
        function renderProfilePage() {
            if (!state.user) return `<h2>Not logged in</h2>`;
            return `<div class="p-6">
                        <h2 class="text-2xl font-bold mb-6">My Details</h2>
                        <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                            <div><p class="text-sm text-gray-500">Name</p><p class="font-semibold">${state.user.name}</p></div>
                            <div><p class="text-sm text-gray-500">Phone</p><p class="font-semibold">${state.user.phoneNumber}</p></div>
                            <div><p class="text-sm text-gray-500">Address</p><p class="font-semibold">${state.user.address}</p></div>
                        </div>
                        <button data-action="logout" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 mt-8">Logout</button>
                    </div>`;
        }

        // ... (renderLogin, renderMenu, renderCart are mostly unchanged) ...
        function renderLogin() { if (!state.loginState.isOtpSent) { return `<div class="p-6"><h2 class="text-2xl font-bold mb-4">Login or Sign Up</h2><p class="text-gray-600 mb-6">Enter your phone number to receive a verification code.</p><form data-action="sendOtp"><input id="phone-number" type="tel" placeholder="+91 12345 67890" class="w-full p-3 border border-gray-300 rounded-lg mb-4" required /><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Send OTP</button></form><div id="recaptcha-container" class="mt-4"></div></div>`; } else { return `<div class="p-6"><h2 class="text-2xl font-bold mb-4">Verify Your Number</h2><p class="text-gray-600 mb-6">Enter the 6-digit code sent to ${state.loginState.phoneNumber}</p><form data-action="verifyOtp"><input id="otp-code" type="number" placeholder="123456" class="w-full p-3 border border-gray-300 rounded-lg mb-4" required /><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Verify OTP</button></form></div>`; } }
        function renderMenu() { const menuItemsHTML = state.menu.map(item => { const itemInCart = state.cart.find(cartItem => cartItem.id === item.id); let addButtonHTML; if (itemInCart) { addButtonHTML = `<div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-24 h-9 bg-white shadow-lg rounded-md flex justify-between items-center text-green-600 font-bold"><button data-action="updateQuantity" data-id="${item.id}" data-change="-1" class="w-8 h-full flex items-center justify-center text-xl">-</button><span class="text-sm">${itemInCart.quantity}</span><button data-action="updateQuantity" data-id="${item.id}" data-change="1" class="w-8 h-full flex items-center justify-center text-xl">+</button></div>`; } else { addButtonHTML = `<button data-action="addToCart" data-id="${item.id}" class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-24 h-9 bg-white text-green-600 font-bold rounded-md shadow-lg text-sm hover:bg-green-50 active:scale-95 transition-all duration-200">ADD</button>`; } return `<div class="flex bg-white p-3 rounded-lg shadow-sm"><div class="flex-1 pr-4"><h3 class="font-bold text-md text-gray-800">${item.name}</h3><p class="text-gray-500 text-sm my-1">${item.description}</p><p class="font-semibold text-gray-900">$${item.price.toFixed(2)}</p></div><div class="relative w-24 h-24 flex-shrink-0"><img src="${item.image}" alt="${item.name}" class="w-full h-full rounded-md object-cover" />${addButtonHTML}</div></div>` }).join(''); return `<div class="p-4 space-y-4"><h1 class="text-3xl font-bold">Good morning!</h1>${menuItemsHTML}</div>`; }
        function renderCart() { if (state.cart.length === 0) { return `<div class="text-center p-8"><h2 class="text-xl font-bold mb-2">Your cart is empty</h2><p class="text-gray-500">Add items from the menu to get started!</p></div>`; } const cartItemsHTML = state.cart.map(item => `<div class="flex items-center justify-between py-3"><div class="flex items-center"><img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover mr-3"/><div><p class="font-semibold text-sm">${item.name}</p><p class="text-gray-600 text-sm">$${item.price.toFixed(2)}</p></div></div><div class="flex items-center border border-gray-300 rounded-md"><button data-action="updateQuantity" data-id="${item.id}" data-change="-1" class="p-1"><svg class="w-4 h-4 text-gray-600 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg></button><span class="px-3 text-sm font-bold">${item.quantity}</span><button data-action="updateQuantity" data-id="${item.id}" data-change="1" class="p-1"><svg class="w-4 h-4 text-gray-600 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path></svg></button></div></div>`).join(''); const subtotal = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0); const deliveryFee = 2.50; const total = subtotal + deliveryFee; return `<div class="p-4 h-full flex flex-col"><h2 class="text-2xl font-bold mb-4">Your Order</h2><div class="flex-1 overflow-y-auto">${cartItemsHTML}</div><div class="border-t pt-4 mt-4"><div class="flex justify-between text-gray-600 mb-1"><p>Subtotal</p><p>$${subtotal.toFixed(2)}</p></div><div class="flex justify-between text-gray-600 mb-2"><p>Delivery Fee</p><p>$${deliveryFee.toFixed(2)}</p></div><div class="flex justify-between font-bold text-lg"><p>Total</p><p>$${total.toFixed(2)}</p></div><button data-action="placeOrder" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg mt-4 hover:bg-green-700 transition-colors">Place Order</button></div></div>`; }

        // ===================================================================================
        // EVENT HANDLERS & LOGIC
        // ===================================================================================

        // MODIFIED: handleVerifyOtp now checks Firestore for user data
        function handleVerifyOtp() {
            const code = document.getElementById('otp-code').value;
            state.loginState.confirmationResult.confirm(code).then((result) => {
                const user = result.user;
                // Check Firestore for this user's data
                const userRef = db.collection('users').doc(user.phoneNumber);
                userRef.get().then((doc) => {
                    if (doc.exists) {
                        // Existing user
                        state.user = { phoneNumber: user.phoneNumber, ...doc.data() };
                        state.view = 'menu';
                    } else {
                        // New user, prompt to create profile
                        state.user = { phoneNumber: user.phoneNumber };
                        state.view = 'createProfile';
                    }
                    state.loginState = { isOtpSent: false, confirmationResult: null, phoneNumber: '' };
                    render();
                });
            }).catch((error) => {
                console.error("Error verifying OTP", error);
                alert("Invalid OTP. Please try again.");
            });
        }
        
        // ADDED: Handler to save new user's profile
        function handleSaveProfile() {
            const name = document.getElementById('name').value;
            const address = document.getElementById('address').value;
            const userProfile = { name, address };

            db.collection('users').doc(state.user.phoneNumber).set(userProfile)
                .then(() => {
                    console.log("Profile saved!");
                    state.user = { ...state.user, ...userProfile };
                    state.view = 'menu';
                    render();
                })
                .catch((error) => {
                    console.error("Error saving profile: ", error);
                    alert("Could not save profile. Please try again.");
                });
        }
        
        // ADDED: Handler for logout
        function handleLogout() {
            auth.signOut().then(() => {
                state.user = null;
                state.cart = [];
                state.view = 'login';
                render();
            }).catch((error) => {
                console.error("Logout Error", error);
            });
        }

        // --- Other handler functions are mostly unchanged ---
        function handleSendOtp() { const phoneNumber = document.getElementById('phone-number').value; const appVerifier = window.recaptchaVerifier; auth.signInWithPhoneNumber(phoneNumber, appVerifier) .then((confirmationResult) => { state.loginState.confirmationResult = confirmationResult; state.loginState.isOtpSent = true; state.loginState.phoneNumber = phoneNumber; render(); }).catch((error) => { console.error("Error sending OTP", error); alert("Error: Could not send OTP. Please check the phone number format (including country code) and try again."); }); }
        function handleSetView(view) { state.view = view; render(); }
        function handleAddToCart(itemId) { const itemInMenu = state.menu.find(item => item.id === itemId); const itemInCart = state.cart.find(item => item.id === itemId); if (itemInCart) { itemInCart.quantity++; } else { state.cart.push({ ...itemInMenu, quantity: 1 }); } render(); }
        function handleUpdateQuantity(itemId, change) { const itemInCart = state.cart.find(item => item.id === itemId); if (itemInCart) { itemInCart.quantity += change; if (itemInCart.quantity <= 0) { state.cart = state.cart.filter(item => item.id !== itemId); } } render(); }
        function handlePlaceOrder() { if (!state.user) { alert("Please log in to place an order."); state.view = 'login'; render(); return; } alert(`Order for ${state.user.name} placed! (This is a demo)`); state.cart = []; state.view = 'menu'; render(); }
        
        // ===================================================================================
        // EVENT LISTENER (Event Delegation)
        // ===================================================================================
        document.getElementById('app').addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target) return;
            const { action, view, id, change } = target.dataset;
            // ADDED: Handle new logout action
            if (action === 'logout') handleLogout();
            if (action === 'setView') handleSetView(view);
            if (action === 'addToCart') handleAddToCart(parseInt(id));
            if (action === 'updateQuantity') handleUpdateQuantity(parseInt(id), parseInt(change));
            if (action === 'placeOrder') handlePlaceOrder();
        });

        document.getElementById('app').addEventListener('submit', function(event) {
             event.preventDefault();
             const { action } = event.target.dataset;
             if (action === 'sendOtp') handleSendOtp();
             if (action === 'verifyOtp') handleVerifyOtp();
             // ADDED: Handle new saveProfile action
             if (action === 'saveProfile') handleSaveProfile();
        });
        
        // ===================================================================================
        // INITIALIZATION
        // ===================================================================================
        render(); // Initial render of the app
    </script>
</body>
</html>
